function queryChanged(){return basicData=null,chartData=null,cityData=null,resultsListItems=null,requestData(),jQuery(".search-results").removeClass("hidden"),!1}function queryUrlForYearAndSentiment(e,t){var a="?query=";return a+=encodeURIComponent(document.getElementById("query").value),a+="&fromYear=",a+=e,a+="&toYear=",a+=e,a+="&fromPersonId=",a+=encodeURIComponent(document.getElementById("fromPersonId").value),a+="&toPersonId=",a+=encodeURIComponent(document.getElementById("toPersonId").value),a+="&fromPlaceId=",a+=encodeURIComponent(document.getElementById("fromPlaceId").value),a+="&toPlaceId=",a+=encodeURIComponent(document.getElementById("toPlaceId").value),a+="&sentiment=",a+=t,a+="&sort=",a+=encodeURIComponent(sortKey),"data/search.php"+a}function requestData(){console.log("RequestData called");var e=!1,t="?query=";t+=encodeURIComponent(document.getElementById("query").value),t+="&fromYear=",t+=encodeURIComponent(document.getElementById("fromYear").value),t+="&toYear=",t+=encodeURIComponent(document.getElementById("toYear").value),t+="&fromPersonId=",t+=encodeURIComponent(document.getElementById("fromPersonId").value),t+="&toPersonId=",t+=encodeURIComponent(document.getElementById("toPersonId").value),t+="&fromPlaceId=",t+=encodeURIComponent(document.getElementById("fromPlaceId").value),t+="&toPlaceId=",t+=encodeURIComponent(document.getElementById("toPlaceId").value),t+="&sentiment=",t+=encodeURIComponent(document.getElementById("sentiment").value),t+="&sort=",t+=encodeURIComponent(sortKey),window.history.pushState({path:t},"",location.origin+location.pathname+t),ga("send","event","search","submit",t);var a="";if(document.getElementById("query").value&&(a="text: <b>"+document.getElementById("query").value+"</b>"),document.getElementById("fromYear").value&&(a+=" starting: <b>"+document.getElementById("fromYear").value+"</b>"),document.getElementById("toYear").value&&(a+=" ending: <b>"+document.getElementById("toYear").value+"</b>"),document.getElementById("fromPersonId").value){var n=document.getElementById("fromPersonId").value;a+=" sender: <b>"+personIdToNames[n]+"</b>"}if(document.getElementById("toPersonId").value){var n=document.getElementById("toPersonId").value;a+=" recipient: <b>"+personIdToNames[n]+"</b>"}if(document.getElementById("fromPlaceId").value){var o=document.getElementById("fromPlaceId").value;a+=" sent from: <b>"+placeIdToNames[o]+"</b>"}if(document.getElementById("toPlaceId").value){var o=document.getElementById("toPlaceId").value;a+=" sent to: <b>"+placeIdToNames[o]+"</b>"}document.getElementById("sentiment").value&&(a+=" with <b>"+document.getElementById("sentiment").value+"</b> sentiment scores"),""==a&&(a="all results."),document.getElementById("humanQuery").innerHTML=a;var r="search_results.php";$.getJSON(r+t,function(e){$(document).trigger("basicDataLoaded",[e])}),e=!0;var r="data/cloud.php";$.getJSON(r+t,function(e){$(document).trigger("chartDataLoaded",[e])}),e=!0;var r="data/cities.php";$.getJSON(r+t,function(e){$(document).trigger("cityDataLoaded",[e])}),e=!0;var r="data/network.php";return $.getJSON(r+t,function(e){$(document).trigger("networkDataLoaded",[e])}),e=!0}function updateDocuments(){var e=($("#documentsList"),basicData.json.length);$("#resultsCount").text(e),$("#totalDocsCount").text(totalDocsCount),$(".search-results__results-summary").removeClass("invisible"),1===e&&(document.getElementById("resultsPlural").innerHTML="result"),$(".search-results__results-summary").addClass("search-results__results-summary--changed").delay(2e3).queue(function(){$(this).removeClass("search-results__results-summary--changed").dequeue()}),paging.setNumber(e).setPage(),$("#sort_"+sortKey).prop("checked",!0)}function updateSentiment(){$(".search-result-list__item-sentiment-score").each(function(){var e=$(this),t=e.attr("data-sentiment");negativeThreshold>t?e.addClass("sentiment-negative"):t>positiveThreshold?e.addClass("sentiment-positive"):e.addClass("sentiment-neutral")})}function updatePage(e){var t=$("#documentsList"),a=basicData.html.slice(e[0],e[1]);t.empty().append(a).first().attr("start",e[0]+1)}function setupMap(){var e={center:new google.maps.LatLng(34,-94),zoom:4,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map"),e),null!=map.getProjection()?redrawAllCurves():google.maps.event.addListener(map,"projection_changed",redrawAllCurves),redrawMarkers(),google.maps.event.addListener(map,"zoom_changed",redrawMarkers)}function cityClicked(e){for(var t=0;t<infoWindows.length;t++)infoWindows[t].close();infoWindows[e].open(map,markers[e])}function searchCity(e){var t="?query=";t+=encodeURIComponent(document.getElementById("query").value),t+="&location=",t+=encodeURIComponent(e),t+="&sort=",t+=encodeURIComponent(sortKey),window.location="search"+t}function rgbToHtml(e,t,a){for(var n=e+256*t+65536*a,o=n.toString(16);o.length<6;)o="0"+o;return"#"+o}function drawCurve(e,t,a,n){var o=e.getProjection(),r=o.fromLatLngToPoint(t),s=o.fromLatLngToPoint(a),l=s.x-r.x,d=s.y-r.y,i=Math.sqrt(Math.pow(l,2)+Math.pow(d,2));i*=n;for(var c,u,m=Math.atan2(d,l)+Math.PI/2,g=new google.maps.Point((r.x+s.x)/2,(r.y+s.y)/2),p=new google.maps.Point(g.x+i*Math.cos(m),g.y+i*Math.sin(m)),h=10,v=!0,y=0;h>=y;y+=1){var I=y/h,f=Math.pow(1-I,2)*r.x+2*(1-I)*I*p.x+Math.pow(I,2)*s.x,b=Math.pow(1-I,2)*r.y+2*(1-I)*I*p.y+Math.pow(I,2)*s.y;if(u=o.fromPointToLatLng(new google.maps.Point(f,b)),!v){var w=Math.floor(255*I),C=rgbToHtml(w,0,255-w),D=[c,u],B=new google.maps.Polyline({path:D,strokeColor:C,strokeOpacity:.1+.4*Math.abs(I-.5),strokeWeight:5});B.setMap(e),lines.push(B)}c=u,v=!1}}function redrawAllCurves(){for(var e=0;e<lines.length;e++)lines[e].setMap(null);lines=[];for(var e=0;e<basicData.json.length;e++)if(doc=basicData.json[e],null!=doc.srcLat&&null!=doc.dstLat){var t=.1+.2*Math.random();drawCurve(map,new google.maps.LatLng(doc.srcLat,doc.srcLng),new google.maps.LatLng(doc.dstLat,doc.dstLng),t)}}function redrawMarkers(){if(console.log("RedrawMarkers called."),null==cityData)return console.log("Aborting."),void console.log(cityData);for(var e=0;e<markers.length;e++)markers[e].setMap(null);markers=[],infoWindows=[];var t;for(t=map.getZoom()>7?cityData.length:Math.min(cityData.length,Math.ceil(Math.pow(map.getZoom(),1.2))),e=0;t>e;e++){var a=cityData[e],n=new google.maps.Marker({position:new google.maps.LatLng(a.lat,a.lng),map:map,title:a.name}),o=function(){cityClicked(arguments.callee.markerIndex)};o.markerIndex=e,google.maps.event.addListener(n,"click",o),markers.push(n);var r="<a style='color:#0000FF;text-decoration:underline;' onClick='searchCity("+a.id+")'> "+a.name+"</a><br /><b>"+(parseInt(a.incoming)+parseInt(a.outgoing))+" Letters</b><br />"+a.incoming+" Incoming Letters<br />"+a.outgoing+" Outgoing Letters<br />",s=new google.maps.InfoWindow({content:r});infoWindows.push(s)}mapNeedsRerender=!1}function updateCharts(){$("svg").remove(),wordChart(chartData[2],"#personChart"),wordChart(chartData[1],"#placeChart"),wordChart(chartData[0],"#wordChart"),chartsNeedRerender=!1}function wordChart(e,t){var a=e,n={top:0,right:0,bottom:0,left:0},o=d3.select(t),r=parseInt(o.style("width"))-parseInt(o.style("padding-left"))-parseInt(o.style("padding-right")),r=r-n.left-n.right,s=20,l=5,d=125,i=(s+l)*a.length-n.top-n.bottom,c=d3.scale.linear().domain([0,d3.max(a,function(e){return parseInt(e.weight,10)})]),u=(d3.scale.ordinal().domain(a.map(function(e){return e.text})).rangeBands([i,0],.1),d3.select(t).append("svg").attr("class","word-chart__outer-svg").attr("width",r+n.left+n.right).attr("height",i+n.top+n.bottom).append("g").attr("class","word-chart__inner-g").attr("width",r).attr("transform","translate("+[n.left,n.top]+")")),m=u.append("g").attr("class","word-chart__label-container");m.selectAll("text").data(a).enter().append("a").attr("class","word-chart__label-link").attr("xlink:href",function(e){return e.link}).append("text").attr("class","word-chart__label-text").attr("transform",function(e,t){return"translate(0,"+t*(s+l)+")"}).attr("dy","1em").text(function(e){return e.text}),d=d3.select(t).select(".word-chart__label-container").node().getBBox().width,c.range([25,r-d]);var g=u.append("g").attr("class","word-chart__bar-container"),p=g.selectAll("g").data(a).enter().append("g").attr("transform",function(e,t){return"translate("+d+","+t*(s+l)+")"});d3.select(u.node().parentNode).style("height",i+n.top+n.bottom+"px"),p.append("rect").attr("class","word-chart__bar").attr("width",function(e){return c(e.weight)}).attr("height",s-1),p.append("text").attr("class","word-chart__item-weight").attr("y",s/2).attr("dy",".35em").text(function(e){return e.weight}).attr("x",function(e){return c(e.weight)-this.getBBox().width-2})}function updateChart(){if(null!=basicData){for(var e={},t={},a={},n={},o=0;o<basicData.json.length;o++){var r=basicData.json[o].date.substring(0,4);void 0===e[r]?e[r]=1:e[r]++,void 0===t[r]&&(t[r]=0,a[r]=0,n[r]=0),basicData.json[o].sentimentScore<negativeThreshold?n[r]++:basicData.json[o].sentimentScore>positiveThreshold?t[r]++:a[r]++}var s=2e3,l=1e3;for(var d in totalDocDistribution)if(parseInt(totalDocDistribution[d])>=15){var i=parseInt(d);s>i&&(s=i),parseInt(d)>l&&(l=i)}for(var c=[["Year","Negative","Neutral","Positive"]],o=s;l>=o;o++){var u=o.toString(),m=0;void 0!==e[u]&&(m=e[u]);var g=0;void 0!==totalDocDistribution[u]&&(g=parseInt(totalDocDistribution[u])),c.push([u,Math.floor(n[u]/g*1e3)/10,Math.floor(a[u]/g*1e3)/10,Math.floor(t[u]/g*1e3)/10])}}var p=google.visualization.arrayToDataTable(c),h={isStacked:!0,title:"Search Results, Distributed by Year",hAxis:{title:"Year"},vAxis:{title:"Percentage out of all documents",minValue:0},series:[{color:"#b70000"},{color:"gray"},{color:"#006600"}]};timeChart.draw(p,h),google.visualization.events.addListener(timeChart,"select",function(){console.log(timeChart.getSelection()[0]);var e=timeChart.getSelection()[0];if("row"in e&&"column"in e){var t=c[e.row+1][0];1==e.column&&(document.getElementById("sentiment").value="negative"),2==e.column&&(document.getElementById("sentiment").value="neutral"),3==e.column&&(document.getElementById("sentiment").value="positive"),document.getElementById("fromYear").value=t,document.getElementById("toYear").value=t,queryChanged(),$('.search-results__tabs a[href="#tab-documents"]').tab("show")}})}var basicData=null,chartData=null,cityData=null,sortKey="date",positiveThreshold=2,negativeThreshold=-2,resultsListItems=null,paging=$(".pagination").paging(0,pagingOpts);paging.setOptions({perpage:20}),paging.setOptions({onSelect:function(e){updatePage(this.slice),updateSentiment(),showPager(this.pages)}}),$(document).on("basicDataLoaded",function(e,t){null!=t&&t!=basicData?(basicData=t,updateDocuments()):alert("?")}),$("input:radio[name=sort]").on("click",function(e){sortKey=$("input:radio[name=sort]:checked").val(),queryChanged()});var mapIsSetup=!1,map,markers=[],lines=[],infoWindows=[];google.load("maps","3",{other_params:"sensor=false"}),$(document).on("cityDataLoaded",function(e,t){null!=t&&t!=cityData&&(cityData=t,mapNeedRerender=!0,"none"!=$("#tab-geographic")[0].style.display&&(redrawAllCurves(),redrawMarkers()))});var chartsNeedRerender=!1;$(document).on("chartDataLoaded",function(e,t){null!=t&&t!=chartData&&(chartData=t,chartsNeedRerender=!0,"none"!=$("#tab-charts").css("display")&&updateCharts())});var timeChart,timeChartNeedsUpdate=!0;google.load("visualization","1",{packages:["corechart"],callback:function(){timeChart=new google.visualization.ColumnChart(document.getElementById("timeChart"))}}),$(document).on("basicDataLoaded",function(e,t){null!=t&&(timeChartNeedsUpdate=!0,"none"!=$("#tab-timeline")[0].style.display&&updateChart())}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){switch(newTabId=$(e.target).attr("href"),newTabId){case"#tab-content":break;case"#tab-timeline":timeChartNeedsUpdate&&updateChart();break;case"#tab-geographic":mapIsSetup!==!0?setupMap():mapNeedsRerender&&(redrawAllCurves(),redrawMarkers());break;case"#tab-charts":chartsNeedRerender&&updateCharts()}});