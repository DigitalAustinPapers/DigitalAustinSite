var basicData=null,cloudData=null,cityData=null,sortKey="date",positiveThreshold=2,negativeThreshold=-2,resultsListItems=null;function queryChanged(){resultsListItems=cityData=cloudData=basicData=null;requestData();jQuery("#tabs").removeClass("hidden");return!1}
function queryUrlForYearAndSentiment(a,c){var b;b="?query="+encodeURIComponent(document.getElementById("query").value);b=b+"&fromYear="+a;b+="&toYear=";b+=a;b+="&fromPersonId=";b+=encodeURIComponent(document.getElementById("fromPersonId").value);b+="&toPersonId=";b+=encodeURIComponent(document.getElementById("toPersonId").value);b+="&fromPlaceId=";b+=encodeURIComponent(document.getElementById("fromPlaceId").value);b+="&toPlaceId=";b+=encodeURIComponent(document.getElementById("toPlaceId").value);
b+="&sentiment=";b+=c;b+="&sort=";b+=encodeURIComponent(sortKey);return"data/search.php"+b}
function requestData(){console.log("RequestData called");var a;a="?query="+encodeURIComponent(document.getElementById("query").value);a=a+"&fromYear="+encodeURIComponent(document.getElementById("fromYear").value);a+="&toYear=";a+=encodeURIComponent(document.getElementById("toYear").value);a+="&fromPersonId=";a+=encodeURIComponent(document.getElementById("fromPersonId").value);a+="&toPersonId=";a+=encodeURIComponent(document.getElementById("toPersonId").value);a+="&fromPlaceId=";a+=encodeURIComponent(document.getElementById("fromPlaceId").value);
a+="&toPlaceId=";a+=encodeURIComponent(document.getElementById("toPlaceId").value);a+="&sentiment=";a+=encodeURIComponent(document.getElementById("sentiment").value);a+="&sort=";a+=encodeURIComponent(sortKey);var c="";document.getElementById("query").value&&(c="text: <b>"+document.getElementById("query").value+"</b>");document.getElementById("fromYear").value&&(c+=" starting: <b>"+document.getElementById("fromYear").value+"</b>");document.getElementById("toYear").value&&(c+=" ending: <b>"+document.getElementById("toYear").value+
"</b>");if(document.getElementById("fromPersonId").value)var b=document.getElementById("fromPersonId").value,c=c+(" sender: <b>"+personIdToNames[b]+"</b>");document.getElementById("toPersonId").value&&(b=document.getElementById("toPersonId").value,c+=" recipient: <b>"+personIdToNames[b]+"</b>");document.getElementById("fromPlaceId").value&&(b=document.getElementById("fromPlaceId").value,c+=" sent from: <b>"+placeIdToNames[b]+"</b>");document.getElementById("toPlaceId").value&&(b=document.getElementById("toPlaceId").value,
c+=" sent to: <b>"+placeIdToNames[b]+"</b>");document.getElementById("sentiment").value&&(c+=" with <b>"+document.getElementById("sentiment").value+"</b> sentiment scores");document.getElementById("humanQuery").innerHTML=c;$.getJSON("search_results.php"+a,function(a){$(document).trigger("basicDataLoaded",[a])});$.getJSON("data/cloud.php"+a,function(a){$(document).trigger("cloudDataLoaded",[a])});$.getJSON("data/cities.php"+a,function(a){$(document).trigger("cityDataLoaded",[a])});$.getJSON("data/network.php"+
a,function(a){$(document).trigger("networkDataLoaded",[a])});return!0}function updateDocuments(){$("#documentsList");var a=basicData.json.length;$("#resultsCount").text(a);$("#totalDocsCount").text(totalDocsCount);$(".pagination").paging(a,pagingOpts);$("#sort_"+sortKey).prop("checked",!0)}$(document).on("basicDataLoaded",function(a,c){null!=c&&c!=basicData?(basicData=c,updateDocuments()):alert("?")});
$("input:radio[name=sort]").on("click",function(a){sortKey=$("input:radio[name=sort]:checked").val();queryChanged()});
var pagingOpts={format:"[< nncnn >]",perpage:10,lapping:0,page:1,onSelect:function(a){updatePage(this.slice);console.log("this");console.log(this)},onFormat:function(a){switch(a){case "block":return this.page===this.value?'<li class="active"><a href="#">'+this.value+"</a></li>":'<li><a href="#">'+this.value+"</a></li>";case "next":return'<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>';case "prev":return'<li><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>';
case "first":return'<li><a href="#">first</a></li>';case "last":return'<li><a href="#">last</a></li>'}}};function updatePage(a){var c=$("#documentsList"),b=basicData.html.slice(a[0],a[1]);c.empty().append(b).first().attr("start",a[0]+1)}var mapIsSetup=!1,map,markers=[],lines=[],infoWindows=[];google.load("maps","3",{other_params:"sensor=false"});
function setupMap(){var a={center:new google.maps.LatLng(34,-94),zoom:4,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map"),a);null!=map.getProjection()?redrawAllCurves():google.maps.event.addListener(map,"projection_changed",redrawAllCurves);redrawMarkers();google.maps.event.addListener(map,"zoom_changed",redrawMarkers)}
$(document).on("cityDataLoaded",function(a,c){null!=c&&c!=cityData&&(cityData=c,mapNeedRerender=!0,"none"!=$("#tab-geographic")[0].style.display&&(redrawAllCurves(),redrawMarkers()))});function cityClicked(a){for(var c=0;c<infoWindows.length;c++)infoWindows[c].close();infoWindows[a].open(map,markers[a])}
function searchCity(a){var c;c="?query="+encodeURIComponent(document.getElementById("query").value);c=c+"&location="+encodeURIComponent(a);c+="&sort=";c+=encodeURIComponent(sortKey);window.location="search"+c}function rgbToHtml(a,c,b){for(a=(a+256*c+65536*b).toString(16);6>a.length;)a="0"+a;return"#"+a}
function drawCurve(a,c,b,g){var f=a.getProjection();c=f.fromLatLngToPoint(c);b=f.fromLatLngToPoint(b);var d=b.x-c.x,e=b.y-c.y,h=Math.sqrt(Math.pow(d,2)+Math.pow(e,2)),h=h*g;g=Math.atan2(e,d)+Math.PI/2;d=new google.maps.Point((c.x+b.x)/2,(c.y+b.y)/2);g=new google.maps.Point(d.x+h*Math.cos(g),d.y+h*Math.sin(g));for(var l,k=!0,h=0;10>=h;h+=1){var d=h/10,e=Math.pow(1-d,2)*c.x+2*(1-d)*d*g.x+Math.pow(d,2)*b.x,m=Math.pow(1-d,2)*c.y+2*(1-d)*d*g.y+Math.pow(d,2)*b.y,e=f.fromPointToLatLng(new google.maps.Point(e,
m));k||(k=Math.floor(255*d),k=rgbToHtml(k,0,255-k),l=new google.maps.Polyline({path:[l,e],strokeColor:k,strokeOpacity:.1+.4*Math.abs(d-.5),strokeWeight:5}),l.setMap(a),lines.push(l));l=e;k=!1}}
function redrawAllCurves(){for(var a=0;a<lines.length;a++)lines[a].setMap(null);lines=[];for(a=0;a<basicData.json.length;a++)if(doc=basicData.json[a],null!=doc.srcLat&&null!=doc.dstLat){var c=.1+.2*Math.random();drawCurve(map,new google.maps.LatLng(doc.srcLat,doc.srcLng),new google.maps.LatLng(doc.dstLat,doc.dstLng),c)}}
function redrawMarkers(){console.log("RedrawMarkers called.");if(null==cityData)console.log("Aborting."),console.log(cityData);else{for(var a=0;a<markers.length;a++)markers[a].setMap(null);markers=[];infoWindows=[];var c;c=7<map.getZoom()?cityData.length:Math.min(cityData.length,Math.ceil(Math.pow(map.getZoom(),1.2)));for(a=0;a<c;a++){var b=cityData[a],g=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lng),map:map,title:b.name}),f=function(){cityClicked(arguments.callee.markerIndex)};
f.markerIndex=a;google.maps.event.addListener(g,"click",f);markers.push(g);b="<a style='color:#0000FF;text-decoration:underline;' onClick='searchCity("+b.id+")'> "+b.name+"</a><br /><b>"+(parseInt(b.incoming)+parseInt(b.outgoing))+" Letters</b><br />"+b.incoming+" Incoming Letters<br />"+b.outgoing+" Outgoing Letters<br />";b=new google.maps.InfoWindow({content:b});infoWindows.push(b)}mapNeedsRerender=!1}}var cloudsNeedRerender=!1;
function updateClouds(){$("#wordCloud").empty();$("#personCloud").empty();$("#placeCloud").empty();$("#wordCloud").jQCloud(cloudData[0]);$("#personCloud").jQCloud(cloudData[2]);$("#placeCloud").jQCloud(cloudData[1]);cloudsNeedRerender=!1}$(document).on("cloudDataLoaded",function(a,c){null!=c&&c!=cloudData&&(cloudData=c,cloudsNeedRerender=!0,"none"!=$("#tab-clouds").css("display")&&updateClouds())});var timeChart,timeChartNeedsUpdate=!0;
google.load("visualization","1",{packages:["corechart"],callback:function(){timeChart=new google.visualization.ColumnChart(document.getElementById("timeChart"))}});
function updateChart(){if(null!=basicData){for(var a={},c={},b={},g={},f=0;f<basicData.json.length;f++){var d=basicData.json[f].date.substring(0,4);void 0===a[d]?a[d]=1:a[d]++;void 0===c[d]&&(c[d]=0,b[d]=0,g[d]=0);basicData.json[f].sentimentScore<negativeThreshold?g[d]++:basicData.json[f].sentimentScore>positiveThreshold?c[d]++:b[d]++}var f=2E3,a=1E3,e;for(e in totalDocDistribution)15<=parseInt(totalDocDistribution[e])&&(d=parseInt(e),d<f&&(f=d),parseInt(e)>a&&(a=d));for(var h=[["Year","Negative",
"Neutral","Positive"]];f<=a;f++)e=f.toString(),d=0,void 0!==totalDocDistribution[e]&&(d=parseInt(totalDocDistribution[e])),h.push([e,Math.floor(g[e]/d*1E3)/10,Math.floor(b[e]/d*1E3)/10,Math.floor(c[e]/d*1E3)/10])}c=google.visualization.arrayToDataTable(h);timeChart.draw(c,{isStacked:!0,title:"Search Results, Distributed by Year",hAxis:{title:"Year"},vAxis:{title:"Percentage out of all documents",minValue:0},series:[{color:"#b70000"},{color:"gray"},{color:"#006600"}]});google.visualization.events.addListener(timeChart,
"select",function(){console.log(timeChart.getSelection()[0]);var a=timeChart.getSelection()[0];if("row"in a&&"column"in a){var b=h[a.row+1][0];1==a.column&&(document.getElementById("sentiment").value="negative");2==a.column&&(document.getElementById("sentiment").value="neutral");3==a.column&&(document.getElementById("sentiment").value="positive");document.getElementById("fromYear").value=b;document.getElementById("toYear").value=b;queryChanged();$("#tabs").tabs("option","active",0)}})}
$(document).on("basicDataLoaded",function(a,c){null!=c&&(timeChartNeedsUpdate=!0,"none"!=$("#tab-timeline")[0].style.display&&updateChart())});$('a[data-toggle="tab"]').on("show.bs.tab",function(a){newTabId=$(a.target).attr("href");switch(newTabId){case "#tab-timeline":timeChartNeedsUpdate&&updateChart();break;case "#tab-geographic":!0!==mapIsSetup?setupMap():mapNeedsRerender&&(redrawAllCurves(),redrawMarkers());break;case "#tab-clouds":cloudsNeedRerender&&updateClouds()}});
