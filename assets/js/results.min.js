var basicData=null,chartData=null,cityData=null,sortKey="date",positiveThreshold=2,negativeThreshold=-2,resultsListItems=null;function queryChanged(){resultsListItems=cityData=chartData=basicData=null;requestData();jQuery(".search-results").removeClass("hidden");return!1}
function queryUrlForYearAndSentiment(a,b){var c;c="?query="+encodeURIComponent(document.getElementById("query").value);c=c+"&fromYear="+a;c+="&toYear=";c+=a;c+="&fromPersonId=";c+=encodeURIComponent(document.getElementById("fromPersonId").value);c+="&toPersonId=";c+=encodeURIComponent(document.getElementById("toPersonId").value);c+="&fromPlaceId=";c+=encodeURIComponent(document.getElementById("fromPlaceId").value);c+="&toPlaceId=";c+=encodeURIComponent(document.getElementById("toPlaceId").value);
c+="&sentiment=";c+=b;c+="&sort=";c+=encodeURIComponent(sortKey);return"data/search.php"+c}
function requestData(){console.log("RequestData called");var a;a="?query="+encodeURIComponent(document.getElementById("query").value);a=a+"&fromYear="+encodeURIComponent(document.getElementById("fromYear").value);a+="&toYear=";a+=encodeURIComponent(document.getElementById("toYear").value);a+="&fromPersonId=";a+=encodeURIComponent(document.getElementById("fromPersonId").value);a+="&toPersonId=";a+=encodeURIComponent(document.getElementById("toPersonId").value);a+="&fromPlaceId=";a+=encodeURIComponent(document.getElementById("fromPlaceId").value);
a+="&toPlaceId=";a+=encodeURIComponent(document.getElementById("toPlaceId").value);a+="&sentiment=";a+=encodeURIComponent(document.getElementById("sentiment").value);a+="&sort=";a+=encodeURIComponent(sortKey);window.history.pushState({path:a},"",location.origin+location.pathname+a);ga("send","event","search","submit",a);var b="";document.getElementById("query").value&&(b="text: <b>"+document.getElementById("query").value+"</b>");document.getElementById("fromYear").value&&(b+=" starting: <b>"+document.getElementById("fromYear").value+
"</b>");document.getElementById("toYear").value&&(b+=" ending: <b>"+document.getElementById("toYear").value+"</b>");if(document.getElementById("fromPersonId").value)var c=document.getElementById("fromPersonId").value,b=b+(" sender: <b>"+personIdToNames[c]+"</b>");document.getElementById("toPersonId").value&&(c=document.getElementById("toPersonId").value,b+=" recipient: <b>"+personIdToNames[c]+"</b>");document.getElementById("fromPlaceId").value&&(c=document.getElementById("fromPlaceId").value,b+=
" sent from: <b>"+placeIdToNames[c]+"</b>");document.getElementById("toPlaceId").value&&(c=document.getElementById("toPlaceId").value,b+=" sent to: <b>"+placeIdToNames[c]+"</b>");document.getElementById("sentiment").value&&(b+=" with <b>"+document.getElementById("sentiment").value+"</b> sentiment scores");""==b&&(b="all results.");document.getElementById("humanQuery").innerHTML=b;$.getJSON("search_results.php"+a,function(a){$(document).trigger("basicDataLoaded",[a])});$.getJSON("data/cloud.php"+a,
function(a){$(document).trigger("chartDataLoaded",[a])});$.getJSON("data/cities.php"+a,function(a){$(document).trigger("cityDataLoaded",[a])});$.getJSON("data/network.php"+a,function(a){$(document).trigger("networkDataLoaded",[a])});return!0}var paging=$(".pagination").paging(0,pagingOpts);paging.setOptions({perpage:20});paging.setOptions({onSelect:function(a){updatePage(this.slice);updateSentiment();showPager(this.pages)}});
function updateDocuments(){$("#documentsList");var a=basicData.json.length;$("#resultsCount").text(a);$("#totalDocsCount").text(totalDocsCount);$(".search-results__results-summary").removeClass("invisible");1===a&&(document.getElementById("resultsPlural").innerHTML="result");$(".search-results__results-summary").addClass("search-results__results-summary--changed").delay(2E3).queue(function(){$(this).removeClass("search-results__results-summary--changed").dequeue()});paging.setNumber(a).setPage();
$("#sort_"+sortKey).prop("checked",!0)}$(document).on("basicDataLoaded",function(a,b){null!=b&&b!=basicData?(basicData=b,updateDocuments()):alert("?")});$("input:radio[name=sort]").on("click",function(a){sortKey=$("input:radio[name=sort]:checked").val();queryChanged()});
function updateSentiment(){$(".search-result-list__item-sentiment-score").each(function(){var a=$(this),b=a.attr("data-sentiment");b<negativeThreshold?a.addClass("sentiment-negative"):b>positiveThreshold?a.addClass("sentiment-positive"):a.addClass("sentiment-neutral")})}function updatePage(a){var b=$("#documentsList"),c=basicData.html.slice(a[0],a[1]);b.empty().append(c).first().attr("start",a[0]+1)}var mapIsSetup=!1,map,markers=[],lines=[],infoWindows=[];google.load("maps","3",{other_params:"sensor=false"});
function setupMap(){var a={center:new google.maps.LatLng(34,-94),zoom:4,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map"),a);null!=map.getProjection()?redrawAllCurves():google.maps.event.addListener(map,"projection_changed",redrawAllCurves);redrawMarkers();google.maps.event.addListener(map,"zoom_changed",redrawMarkers)}
$(document).on("cityDataLoaded",function(a,b){null!=b&&b!=cityData&&(cityData=b,mapNeedRerender=!0,"none"!=$("#tab-geographic")[0].style.display&&(redrawAllCurves(),redrawMarkers()))});function cityClicked(a){for(var b=0;b<infoWindows.length;b++)infoWindows[b].close();infoWindows[a].open(map,markers[a])}
function searchCity(a){var b;b="?query="+encodeURIComponent(document.getElementById("query").value);b=b+"&location="+encodeURIComponent(a);b+="&sort=";b+=encodeURIComponent(sortKey);window.location="search"+b}function rgbToHtml(a,b,c){for(a=(a+256*b+65536*c).toString(16);6>a.length;)a="0"+a;return"#"+a}
function drawCurve(a,b,c,e){var g=a.getProjection();b=g.fromLatLngToPoint(b);c=g.fromLatLngToPoint(c);var d=c.x-b.x,f=c.y-b.y,h=Math.sqrt(Math.pow(d,2)+Math.pow(f,2)),h=h*e;e=Math.atan2(f,d)+Math.PI/2;d=new google.maps.Point((b.x+c.x)/2,(b.y+c.y)/2);e=new google.maps.Point(d.x+h*Math.cos(e),d.y+h*Math.sin(e));for(var l,k=!0,h=0;10>=h;h+=1){var d=h/10,f=Math.pow(1-d,2)*b.x+2*(1-d)*d*e.x+Math.pow(d,2)*c.x,m=Math.pow(1-d,2)*b.y+2*(1-d)*d*e.y+Math.pow(d,2)*c.y,f=g.fromPointToLatLng(new google.maps.Point(f,
m));k||(k=Math.floor(255*d),k=rgbToHtml(k,0,255-k),l=new google.maps.Polyline({path:[l,f],strokeColor:k,strokeOpacity:.1+.4*Math.abs(d-.5),strokeWeight:5}),l.setMap(a),lines.push(l));l=f;k=!1}}
function redrawAllCurves(){for(var a=0;a<lines.length;a++)lines[a].setMap(null);lines=[];for(a=0;a<basicData.json.length;a++)if(doc=basicData.json[a],null!=doc.srcLat&&null!=doc.dstLat){var b=.1+.2*Math.random();drawCurve(map,new google.maps.LatLng(doc.srcLat,doc.srcLng),new google.maps.LatLng(doc.dstLat,doc.dstLng),b)}}
function redrawMarkers(){console.log("RedrawMarkers called.");if(null==cityData)console.log("Aborting."),console.log(cityData);else{for(var a=0;a<markers.length;a++)markers[a].setMap(null);markers=[];infoWindows=[];var b;b=7<map.getZoom()?cityData.length:Math.min(cityData.length,Math.ceil(Math.pow(map.getZoom(),1.2)));for(a=0;a<b;a++){var c=cityData[a],e=new google.maps.Marker({position:new google.maps.LatLng(c.lat,c.lng),map:map,title:c.name}),g=function(){cityClicked(arguments.callee.markerIndex)};
g.markerIndex=a;google.maps.event.addListener(e,"click",g);markers.push(e);c="<a style='color:#0000FF;text-decoration:underline;' onClick='searchCity("+c.id+")'> "+c.name+"</a><br /><b>"+(parseInt(c.incoming)+parseInt(c.outgoing))+" Letters</b><br />"+c.incoming+" Incoming Letters<br />"+c.outgoing+" Outgoing Letters<br />";c=new google.maps.InfoWindow({content:c});infoWindows.push(c)}mapNeedsRerender=!1}}var chartsNeedRerender=!1;
function updateCharts(){$("svg").remove();wordChart(chartData[2],"#personChart");wordChart(chartData[1],"#placeChart");wordChart(chartData[0],"#wordChart");chartsNeedRerender=!1}$(document).on("chartDataLoaded",function(a,b){null!=b&&b!=chartData&&(chartData=b,chartsNeedRerender=!0,"none"!=$("#tab-charts").css("display")&&updateCharts())});
function wordChart(a,b){var c=d3.select(b),e=parseInt(c.style("width"))-parseInt(c.style("padding-left"))-parseInt(c.style("padding-right")),e=e-0-0,g=125,c=25*a.length-0-0,d=d3.scale.linear().domain([0,d3.max(a,function(a){return parseInt(a.weight,10)})]);d3.scale.ordinal().domain(a.map(function(a){return a.text})).rangeBands([c,0],.1);var f=d3.select(b).append("svg").attr("class","word-chart__outer-svg").attr("width",e+0+0).attr("height",c+0+0).append("g").attr("class","word-chart__inner-g").attr("width",
e).attr("transform","translate(0,0)");f.append("g").attr("class","word-chart__label-container").selectAll("text").data(a).enter().append("a").attr("class","word-chart__label-link").attr("xlink:href",function(a){return a.link}).append("text").attr("class","word-chart__label-text").attr("transform",function(a,b){return"translate(0,"+25*b+")"}).attr("dy","1em").text(function(a){return a.text});g=d3.select(b).select(".word-chart__label-container").node().getBBox().width;d.range([25,e-g]);e=f.append("g").attr("class",
"word-chart__bar-container").selectAll("g").data(a).enter().append("g").attr("transform",function(a,b){return"translate("+g+","+25*b+")"});d3.select(f.node().parentNode).style("height",c+0+0+"px");e.append("rect").attr("class","word-chart__bar").attr("width",function(a){return d(a.weight)}).attr("height",19);e.append("text").attr("class","word-chart__item-weight").attr("y",10).attr("dy",".35em").text(function(a){return a.weight}).attr("x",function(a){return d(a.weight)-this.getBBox().width-2})}
var timeChart,timeChartNeedsUpdate=!0;google.load("visualization","1",{packages:["corechart"],callback:function(){timeChart=new google.visualization.ColumnChart(document.getElementById("timeChart"))}});
function updateChart(){if(null!=basicData){for(var a={},b={},c={},e={},g=0;g<basicData.json.length;g++){var d=basicData.json[g].date.substring(0,4);void 0===a[d]?a[d]=1:a[d]++;void 0===b[d]&&(b[d]=0,c[d]=0,e[d]=0);basicData.json[g].sentimentScore<negativeThreshold?e[d]++:basicData.json[g].sentimentScore>positiveThreshold?b[d]++:c[d]++}var g=2E3,a=1E3,f;for(f in totalDocDistribution)15<=parseInt(totalDocDistribution[f])&&(d=parseInt(f),d<g&&(g=d),parseInt(f)>a&&(a=d));for(var h=[["Year","Negative",
"Neutral","Positive"]];g<=a;g++)f=g.toString(),d=0,void 0!==totalDocDistribution[f]&&(d=parseInt(totalDocDistribution[f])),h.push([f,Math.floor(e[f]/d*1E3)/10,Math.floor(c[f]/d*1E3)/10,Math.floor(b[f]/d*1E3)/10])}b=google.visualization.arrayToDataTable(h);timeChart.draw(b,{isStacked:!0,title:"Search Results, Distributed by Year",hAxis:{title:"Year"},vAxis:{title:"Percentage out of all documents",minValue:0},series:[{color:"#b70000"},{color:"gray"},{color:"#006600"}]});google.visualization.events.addListener(timeChart,
"select",function(){console.log(timeChart.getSelection()[0]);var a=timeChart.getSelection()[0];if("row"in a&&"column"in a){var b=h[a.row+1][0];1==a.column&&(document.getElementById("sentiment").value="negative");2==a.column&&(document.getElementById("sentiment").value="neutral");3==a.column&&(document.getElementById("sentiment").value="positive");document.getElementById("fromYear").value=b;document.getElementById("toYear").value=b;queryChanged();$('.search-results__tabs a[href="#tab-documents"]').tab("show")}})}
$(document).on("basicDataLoaded",function(a,b){null!=b&&(timeChartNeedsUpdate=!0,"none"!=$("#tab-timeline")[0].style.display&&updateChart())});$('a[data-toggle="tab"]').on("shown.bs.tab",function(a){newTabId=$(a.target).attr("href");switch(newTabId){case "#tab-timeline":timeChartNeedsUpdate&&updateChart();break;case "#tab-geographic":!0!==mapIsSetup?setupMap():mapNeedsRerender&&(redrawAllCurves(),redrawMarkers());break;case "#tab-charts":chartsNeedRerender&&updateCharts()}});
