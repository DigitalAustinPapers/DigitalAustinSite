var basicData=null,chartData=null,cityData=null,sortKey="date",positiveThreshold=2,negativeThreshold=-2,resultsListItems=null;function queryChanged(){resultsListItems=cityData=chartData=basicData=null;requestData();jQuery(".search-results").removeClass("hidden");return!1}
function queryUrlForYearAndSentiment(a,c){var b;b="?query="+encodeURIComponent(document.getElementById("query").value);b=b+"&fromYear="+a;b+="&toYear=";b+=a;b+="&fromPersonId=";b+=encodeURIComponent(document.getElementById("fromPersonId").value);b+="&toPersonId=";b+=encodeURIComponent(document.getElementById("toPersonId").value);b+="&fromPlaceId=";b+=encodeURIComponent(document.getElementById("fromPlaceId").value);b+="&toPlaceId=";b+=encodeURIComponent(document.getElementById("toPlaceId").value);
b+="&sentiment=";b+=c;b+="&sort=";b+=encodeURIComponent(sortKey);return"data/search.php"+b}
function requestData(){console.log("RequestData called");var a;a="?query="+encodeURIComponent(document.getElementById("query").value);a=a+"&fromYear="+encodeURIComponent(document.getElementById("fromYear").value);a+="&toYear=";a+=encodeURIComponent(document.getElementById("toYear").value);a+="&fromPersonId=";a+=encodeURIComponent(document.getElementById("fromPersonId").value);a+="&toPersonId=";a+=encodeURIComponent(document.getElementById("toPersonId").value);a+="&fromPlaceId=";a+=encodeURIComponent(document.getElementById("fromPlaceId").value);
a+="&toPlaceId=";a+=encodeURIComponent(document.getElementById("toPlaceId").value);a+="&sentiment=";a+=encodeURIComponent(document.getElementById("sentiment").value);a+="&sort=";a+=encodeURIComponent(sortKey);var c="";document.getElementById("query").value&&(c="text: <b>"+document.getElementById("query").value+"</b>");document.getElementById("fromYear").value&&(c+=" starting: <b>"+document.getElementById("fromYear").value+"</b>");document.getElementById("toYear").value&&(c+=" ending: <b>"+document.getElementById("toYear").value+
"</b>");if(document.getElementById("fromPersonId").value)var b=document.getElementById("fromPersonId").value,c=c+(" sender: <b>"+personIdToNames[b]+"</b>");document.getElementById("toPersonId").value&&(b=document.getElementById("toPersonId").value,c+=" recipient: <b>"+personIdToNames[b]+"</b>");document.getElementById("fromPlaceId").value&&(b=document.getElementById("fromPlaceId").value,c+=" sent from: <b>"+placeIdToNames[b]+"</b>");document.getElementById("toPlaceId").value&&(b=document.getElementById("toPlaceId").value,
c+=" sent to: <b>"+placeIdToNames[b]+"</b>");document.getElementById("sentiment").value&&(c+=" with <b>"+document.getElementById("sentiment").value+"</b> sentiment scores");""==c&&(c="all results.");document.getElementById("humanQuery").innerHTML=c;$.getJSON("search_results.php"+a,function(a){$(document).trigger("basicDataLoaded",[a])});$.getJSON("data/cloud.php"+a,function(a){$(document).trigger("chartDataLoaded",[a])});$.getJSON("data/cities.php"+a,function(a){$(document).trigger("cityDataLoaded",
[a])});$.getJSON("data/network.php"+a,function(a){$(document).trigger("networkDataLoaded",[a])});return!0}function updateDocuments(){$("#documentsList");var a=basicData.json.length;$("#resultsCount").text(a);$("#totalDocsCount").text(totalDocsCount);$(".search-results__results-summary").removeClass("invisible");1===a&&(document.getElementById("resultsPlural").innerHTML="result");$(".pagination").paging(a,pagingOpts);$("#sort_"+sortKey).prop("checked",!0)}
$(document).on("basicDataLoaded",function(a,c){null!=c&&c!=basicData?(basicData=c,updateDocuments()):alert("?")});$("input:radio[name=sort]").on("click",function(a){sortKey=$("input:radio[name=sort]:checked").val();queryChanged()});
function updateSentiment(){$(".search-result-list__item-sentiment-score").each(function(){var a=$(this),c=a.attr("data-sentiment");c<negativeThreshold?a.addClass("sentiment-negative"):c>positiveThreshold?a.addClass("sentiment-positive"):a.addClass("sentiment-neutral")})}
var pagingOpts={format:"[< nncnn >]",perpage:10,lapping:0,page:1,onSelect:function(a){updatePage(this.slice);updateSentiment();a=$(".pagination");1<this.pages?a.removeClass("hidden"):a.hasClass("hidden")||a.addClass("hidden")},onFormat:function(a){switch(a){case "block":return this.page===this.value?'<li class="active"><a href="#">'+this.value+"</a></li>":'<li><a href="#">'+this.value+"</a></li>";case "next":return'<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>';
case "prev":return'<li><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>';case "first":return'<li><a href="#">first</a></li>';case "last":return'<li><a href="#">last</a></li>'}}};function updatePage(a){var c=$("#documentsList"),b=basicData.html.slice(a[0],a[1]);c.empty().append(b).first().attr("start",a[0]+1)}var mapIsSetup=!1,map,markers=[],lines=[],infoWindows=[];google.load("maps","3",{other_params:"sensor=false"});
function setupMap(){var a={center:new google.maps.LatLng(34,-94),zoom:4,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map"),a);null!=map.getProjection()?redrawAllCurves():google.maps.event.addListener(map,"projection_changed",redrawAllCurves);redrawMarkers();google.maps.event.addListener(map,"zoom_changed",redrawMarkers)}
$(document).on("cityDataLoaded",function(a,c){null!=c&&c!=cityData&&(cityData=c,mapNeedRerender=!0,"none"!=$("#tab-geographic")[0].style.display&&(redrawAllCurves(),redrawMarkers()))});function cityClicked(a){for(var c=0;c<infoWindows.length;c++)infoWindows[c].close();infoWindows[a].open(map,markers[a])}
function searchCity(a){var c;c="?query="+encodeURIComponent(document.getElementById("query").value);c=c+"&location="+encodeURIComponent(a);c+="&sort=";c+=encodeURIComponent(sortKey);window.location="search"+c}function rgbToHtml(a,c,b){for(a=(a+256*c+65536*b).toString(16);6>a.length;)a="0"+a;return"#"+a}
function drawCurve(a,c,b,g){var e=a.getProjection();c=e.fromLatLngToPoint(c);b=e.fromLatLngToPoint(b);var d=b.x-c.x,f=b.y-c.y,h=Math.sqrt(Math.pow(d,2)+Math.pow(f,2)),h=h*g;g=Math.atan2(f,d)+Math.PI/2;d=new google.maps.Point((c.x+b.x)/2,(c.y+b.y)/2);g=new google.maps.Point(d.x+h*Math.cos(g),d.y+h*Math.sin(g));for(var l,k=!0,h=0;10>=h;h+=1){var d=h/10,f=Math.pow(1-d,2)*c.x+2*(1-d)*d*g.x+Math.pow(d,2)*b.x,m=Math.pow(1-d,2)*c.y+2*(1-d)*d*g.y+Math.pow(d,2)*b.y,f=e.fromPointToLatLng(new google.maps.Point(f,
m));k||(k=Math.floor(255*d),k=rgbToHtml(k,0,255-k),l=new google.maps.Polyline({path:[l,f],strokeColor:k,strokeOpacity:.1+.4*Math.abs(d-.5),strokeWeight:5}),l.setMap(a),lines.push(l));l=f;k=!1}}
function redrawAllCurves(){for(var a=0;a<lines.length;a++)lines[a].setMap(null);lines=[];for(a=0;a<basicData.json.length;a++)if(doc=basicData.json[a],null!=doc.srcLat&&null!=doc.dstLat){var c=.1+.2*Math.random();drawCurve(map,new google.maps.LatLng(doc.srcLat,doc.srcLng),new google.maps.LatLng(doc.dstLat,doc.dstLng),c)}}
function redrawMarkers(){console.log("RedrawMarkers called.");if(null==cityData)console.log("Aborting."),console.log(cityData);else{for(var a=0;a<markers.length;a++)markers[a].setMap(null);markers=[];infoWindows=[];var c;c=7<map.getZoom()?cityData.length:Math.min(cityData.length,Math.ceil(Math.pow(map.getZoom(),1.2)));for(a=0;a<c;a++){var b=cityData[a],g=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lng),map:map,title:b.name}),e=function(){cityClicked(arguments.callee.markerIndex)};
e.markerIndex=a;google.maps.event.addListener(g,"click",e);markers.push(g);b="<a style='color:#0000FF;text-decoration:underline;' onClick='searchCity("+b.id+")'> "+b.name+"</a><br /><b>"+(parseInt(b.incoming)+parseInt(b.outgoing))+" Letters</b><br />"+b.incoming+" Incoming Letters<br />"+b.outgoing+" Outgoing Letters<br />";b=new google.maps.InfoWindow({content:b});infoWindows.push(b)}mapNeedsRerender=!1}}var chartsNeedRerender=!1;
function updateCharts(){$("svg").remove();wordChart(chartData[2],"#personChart");wordChart(chartData[1],"#placeChart");wordChart(chartData[0],"#wordChart");chartsNeedRerender=!1}$(document).on("chartDataLoaded",function(a,c){null!=c&&c!=chartData&&(chartData=c,chartsNeedRerender=!0,"none"!=$("#tab-charts").css("display")&&updateCharts())});
function wordChart(a,c){var b=parseInt(d3.select(c).style("width"),10),b=b-10-10,g=25*a.length-30-30,e=d3.scale.linear().domain([0,d3.max(a,function(a){return parseInt(a.weight,10)})]).range([0,b-125-40]);d3.scale.ordinal().domain(a.map(function(a){return a.text})).rangeBands([g,0],.1);var b=d3.select(c).append("svg").attr("width",b+10+10).attr("height",g+30+30).append("g").attr("transform","translate(10,30)"),d=b.selectAll("g").data(a).enter().append("g").attr("transform",function(a,b){return"translate(135,"+
25*b+")"});d3.select(b.node().parentNode).style("height",g+30+30+"px");d.append("rect").attr("fill","red").attr("class","bar").attr("width",function(a){return e(a.weight)}).attr("height",19);d.append("text").attr("x",function(a){return e(a.weight-3)}).attr("y",10).attr("fill","black").attr("dy",".35em").text(function(a){return a.weight});b.append("g").attr("class","label-container").selectAll("text").data(a).enter().append("a").attr("xlink:href",function(a){return"search?query='"+a.text+"'"}).append("text").attr("class",
"label").attr("transform",function(a,b){return"translate(0,"+25*b+")"}).attr("dy",".75em").text(function(a){return a.text}).attr("color","black")}var timeChart,timeChartNeedsUpdate=!0;google.load("visualization","1",{packages:["corechart"],callback:function(){timeChart=new google.visualization.ColumnChart(document.getElementById("timeChart"))}});
function updateChart(){if(null!=basicData){for(var a={},c={},b={},g={},e=0;e<basicData.json.length;e++){var d=basicData.json[e].date.substring(0,4);void 0===a[d]?a[d]=1:a[d]++;void 0===c[d]&&(c[d]=0,b[d]=0,g[d]=0);basicData.json[e].sentimentScore<negativeThreshold?g[d]++:basicData.json[e].sentimentScore>positiveThreshold?c[d]++:b[d]++}var e=2E3,a=1E3,f;for(f in totalDocDistribution)15<=parseInt(totalDocDistribution[f])&&(d=parseInt(f),d<e&&(e=d),parseInt(f)>a&&(a=d));for(var h=[["Year","Negative",
"Neutral","Positive"]];e<=a;e++)f=e.toString(),d=0,void 0!==totalDocDistribution[f]&&(d=parseInt(totalDocDistribution[f])),h.push([f,Math.floor(g[f]/d*1E3)/10,Math.floor(b[f]/d*1E3)/10,Math.floor(c[f]/d*1E3)/10])}c=google.visualization.arrayToDataTable(h);timeChart.draw(c,{isStacked:!0,title:"Search Results, Distributed by Year",hAxis:{title:"Year"},vAxis:{title:"Percentage out of all documents",minValue:0},series:[{color:"#b70000"},{color:"gray"},{color:"#006600"}]});google.visualization.events.addListener(timeChart,
"select",function(){console.log(timeChart.getSelection()[0]);var a=timeChart.getSelection()[0];if("row"in a&&"column"in a){var b=h[a.row+1][0];1==a.column&&(document.getElementById("sentiment").value="negative");2==a.column&&(document.getElementById("sentiment").value="neutral");3==a.column&&(document.getElementById("sentiment").value="positive");document.getElementById("fromYear").value=b;document.getElementById("toYear").value=b;queryChanged();$(".search-results").tabs("option","active",0)}})}
$(document).on("basicDataLoaded",function(a,c){null!=c&&(timeChartNeedsUpdate=!0,"none"!=$("#tab-timeline")[0].style.display&&updateChart())});$('a[data-toggle="tab"]').on("shown.bs.tab",function(a){newTabId=$(a.target).attr("href");switch(newTabId){case "#tab-timeline":timeChartNeedsUpdate&&updateChart();break;case "#tab-geographic":!0!==mapIsSetup?setupMap():mapNeedsRerender&&(redrawAllCurves(),redrawMarkers());break;case "#tab-charts":chartsNeedRerender&&updateCharts()}});
